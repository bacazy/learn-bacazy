# 计算机网络-网络层

网络层关注的是如何将分组从源端沿着网络路径送达到目标端。

在网络层/传输层的接口面上，网络层向传输层提供服务。对于设计自由度的争议比较大，集中在网络层应该提供面向连接的服务还是提供无连接的服务。

提供面向无连的服务的支持者认为，路由器的任务仅仅是传送分组，不用在所别的事情。另一阵营则认为，子网应该提供可靠的、面向连接的服务，在他们的观点中，服务质量是最重要的因素，如果子网中没有连接，那么实现服务质量是很困难的，特别是对于诸如语音和视频这类的实时流量。

如果提供的服务是无连接的服务，那么所有的分组都被独立的传送到子网中，并且独立于路由，不需要提前建立任何的辅助设施。这样的的上下文环境称为数据报，这样的子网被称为数据报子网。如果使用的是面向连接的服务时，那么在发送数据分组之前，必须先建立起一条从源机器到目标路由器之间的路径。这个连接称为虚电路，且子网称为虚电路子网。这两个子网对比如下：

|      比较项      |    数据报子网     |   虚电路子网   |
|------------------|------------------|----------------|
| 建立电路 | 不需要 | 需要 |
| 地址信息 | 每个分组包含完整的源地址和目的地址 | 每个分组包含一个很短的虚电路号 |
| 状态信息 | 路由器不包含任何的有关连接的状态信息 | 每个虚电路都要求路由器为每一个连接建立表项 |
| 路由     | 每个分组都被独立的路由 | 当虚电路建立的时候选择路径，所有的分组都沿着这条路径 |
| 路由器失效的影响 | 没有影响，除非在崩溃中分组丢失 | 所有经过此失效路由的虚电路都将中止 |
| 服务质量 | 很难实现 | 如果有足够的资源可以提前分配给每一个虚电路，则很容易实现 |
| 拥塞控制 | 很难实现 | 如果有足够的资源可以提前分配给每一个虚电路，则容易实现 |

## 路由算法

如果子网内部使用了数据报，那么路由器在每次分组到达时都会重新选择路径。如果使用了虚电路，那么当虚电路建立时，才需要建立路由。一个好的路由算法应当具备：正确性、简单性、健壮性、公平性和最优性。
```
最优化原则：如果路由器J是在从路由器I到K的最优路径上，那么，从J到K的最优路劲也必定是沿着同样的路由路径。
```

### 最短路径路由
建立一个子网图，图中每一个节点代表一台路由器，每条弧代表一条通信线路。为了在一对给定的路由器之间选择一条路由路径，路由算法只需要在图中找到这对节点之间的最短路劲即可。

衡量路径长度可以是距离、带宽、平均流量、通信开销、平均队列长度、延迟等。可以使用加权函数使用多种准则选择最短路径。

具体算法思想详见[数据结构-图](/DA/DA-graph.md)Dijkstra算法。

### 扩散法

每一个新进来的分组将被发送到除了它进来的那条路线之外的每一条输出线路上。扩散法会产生大量的重复分组，除非采取一种办法来抑制扩散过程，否则扩散法将会产生无限多的分组。一个稍微实际点的算法是选择性扩散。在这个算法中，路由器并不是将每个新进来的分组都输出到每一条线路上，而只是输出到那些方位大概正确的路线上。

### 距离矢量路由
每个路由器维护一张表，表中列出了当前已知到每个目标的最佳距离，以及所使用的线路。通过在邻居间相互交换信息，路由器不断地更新他们内部的表。

距离矢量路由算法中，每个路由器维护了一张路由表，它以子网中的每个路由器为索引，并且每一个路由器对应一个表项。该表包含两部分：为了到达目标路由器而首先使用的输出线路，以及达到该目标路由器的时间估计值或者距离估计值。

特点：对好消息反应特别快，对坏消息的反应非常迟缓。例如存在一个路由器，它到目标X的最佳路径非常大，如果在下一次交换信息的时候，邻居A突然报告说它到X有一个非常短的延迟，那么该路由器只需要将发送给X的流量切换到通向A的线路上。经过一次矢量交换，好消息就起作用了。好消息扩散速度时每交换一次就往远处走一跳。如果一个子网中最长的路径是N跳的话，那么经过N次交换之后，每一个路由器都将知道新恢复的路由器和线路。
//TODO: 传播的慢的原因
//编程实验：

### 链路状态路由

每一个路由器的必须完成以下5个部分的工作：
1. 发现它的邻居节点，并知道其网络地址
1. 测量到各邻居节点的延迟或者开销
1. 构造一个分组，分组中包含所有它刚刚知道的信息
1. 将这个分组发送给所有其他的路由器
1. 计算出到每一个其他路由器的最短路径

完整的拓扑结构和所有的延迟信息都是用实验的方法来测量，并分发给每一个路由器。然后每一个路由器运行DijKstra算法就可以找到从它到每一个其他路由器的最短路径。

#### 发现邻居节点
当一个路由器启动的时候，它的第一个任务是找出哪些路由器是他的邻居，为了发现这个目标，只需要在一条点到点的线路上发送一个特殊的Hello分组即可，线路的另一端的路由器应该送回一个应答来说明它是谁。

#### 测量链路开销
在线路上发送一条特殊的ECHO分组，另一端必须立即送回一个应答。
#### 创建链路状态分组
一旦所需要的交换信息已经收集到了，每一个路由器的下一步工作是建立一个包含所有这些数组的分组。该分组的内容首先是发送方的标识，接着是一个序列号，以及一个邻居列表。对于每一个邻居也要给出到这邻居的延迟。
#### 发布链路状态分组
这是最需要技巧的部分。当分组被发布出去并且被安装以后，首先获得该分组的路由器将改变他们的路由路径，因此，不同路由器有可能使用不同的拓扑结构，从而导致不一致性、环、不可到达的机器、或者其他的问题等。

最简单的发布算法就是扩散法：为了控制扩散过程，每一个分组都包含一个序列号，序列号随着每一个新的分组而递增，每个路由器记录下所有它看到的（源机器、序列号）对。当新的链路状态分组进来的时候，路由器就会检查是不是最新的分组，如果不是则直接丢弃。

#### 计算新的路由路径
一旦一个路由器已经获得了全部的链路状态分组之后，它就可以构造出子网图了。路由器就可以在本地运行Dijkstra算法，以便构造出所有可能目标的最短路径。

### 分级路由
当网络中的节点增长到一定的量级时，网络中的路由器不太可能维护路由表。那么就需要将网络进行分级，路由选择也分级进行。每个路由器知道如何分组路由到自己所在区域内的地址，但是对于其他区域的内部结构毫不知情。

### 广播路由
一到多的发布过程，常见的算法有：

1. 源机器简单的给每一个目标机器发送分组，这种方法不仅浪费资源，也要求源机器拥有所有目标机器的完整列表。
1. 扩散法：扩散过程产生大量分组，从而消耗大量的带宽
1. 多目标路由：
1. 汇集树：
1. 逆向路径转发:

### 多播路由
在一些分布在各处的进程需要以组的方式协同工作，比如一组进程实现了一个分布式数据库。在这种情形下，组中的进程常常需要给其他所有成员发送消息。如果组的规模较小，那么只需要点到点的方式即可，如果规模较大，那么这种测量的代价就会非常昂贵。给这样的组发送消息称为组播，它的路由算法称为多播路由。

### 对等网络
阅读

## 拥塞控制

拥塞的发生有多种因素。如果突然之间在三条或者四条输入线路上开始有分组到达，而这些分组流都需要同样的输出线路，那么。路由器将建立一个队列。如果路由器没有足够的内存，那么分组就会丢失。增加内存可以将路由器的性能提升到一定程度，但是提高的很大，拥塞会变得更严重，这是因为当分组到达队列前端时，这些分组已经超时了，重复的分组也已经被发送出来了。所有这些分组都将被发送出去，这将增加整条路径的负载。慢速的处理器也可能引起拥塞。

**拥塞控制和流控制：** 拥塞控制的任务是确保子网能够承载所达到的流量。流控制只与特定的发送方和接收方之间的点到点流量有关。

### 拥塞预防策略

|   层   |  策略                                           |
|--------|------------------------------------------------|
| 传输层 | 1. 重传 2.乱序缓存 3.确认策略 4.流控制策略 5.确定超时策略 |
| 网络层 | 1.子网内部虚电路与数据报策略 2.分组排队和服务策略 3.分组丢弃策略 4.路由算法 5.分组生存期管理 |
| 数据链路层 | 1.重传策略 2.乱序缓存策略 3.确认策略 4.流控制策略 |

### 虚电路子网中的拥塞控制
上面的拥塞控制是开环的：他们都试图从一开始就避免出现拥塞，而不是在拥塞发生时在控制。

一种应用广泛、防止已拥塞的子网进一步恶化的技术是**准入控制**。一旦出现拥塞信号，则不再创建任何虚电路，直到问题排除为止。
另一种方法是允许建立新的虚电路，但是需要谨慎的选择路由，使所有新的虚电路都绕开有问题的区域。

### 数据报子网中的拥塞控制
每台路由器很容易就可以监听到他的输出线路和其他资源的使用情况。通过一种计算方法获得一个数值来评价该路由器能提供服务的质量。当该数值达到特定的阈值时，该输出线路进入一个警告状态。

1. 设置警告位的方法：在分组的头中设置一个特殊的位来警示警告状态，当分组到达它的目标端的时候，传输实体将这一位复制到下一个确认分组中，所以这一位也被送回到源主机，然后源主机削减流量。只要路由器处于警告状态中，它就会不断设置警告位，这就意味着源主机会不停的收到设置了警告位的确认分组，源主机就不停地减小传输速率。直到所有的路由器都排除了问题之后，流量才可以增加上去。
1. 抑制分组法：警告位的方法过于精细，它使用了一种非常曲折的方法通知主机放慢速度。这种方法中，路由器直接给源主机送回一个抑制分组，并且在抑制分组中指明原分组的目标地址。同时，原来的分组被加上一个标记，因而在它传输的路径上不会再产生更多的抑制分组。
1. 逐跳抑制分组：当网络速度很高或者路由器离源主机很远的时候，给源主机发送抑制分组并不能起到良好的作用，因为反应太慢。另一种解决办法就是抑制分组影响到沿途的每一跳。

### 负载丢弃
当任何一种方法都不能消除拥堵的话，路由器就可以丢弃分组。

## 服务质量
为了获得服务质量需要的技术
1. 过度提供资源
1. 缓冲能力，在接收方，数据流在被递交之前可以先缓存起来。将数据流缓存起来并不会影响到可靠性和带宽，但会增加延迟，然而这样可以消除抖动。
1. 流量整形：有些情况下，源端会不规律地发送分组，这些分组可能在网络中造成拥堵。如果采取措施保证源主机会议均衡的速率来发送分组，那么服务质量将会更好。流量整形技术可以做到这一点。流量整形是指调节数据传输速率。
1. 漏桶算法：每一个主机连接到网络中都包含一个漏桶，即一个有限长度的队列。如果队列满的时候就会丢弃。
1. 令牌桶：漏桶算法是强迫输出模式保持严格的均匀速率，而不管通信流量的突发性程度如何。对于许多应用，更好的做法是，当大量突发数据到来的时候，应该允许输出流适当的加快，因此需要一个更加灵活，并且不会丢失数据做法。令牌桶算法提供了一种不同于漏桶算法的整形方法。漏桶算法不允许空闲的主机将许可权保存起来以便以后可以发送大的突发数据。而令牌桶算法则允许将许可全保存起来，直至到桶的最大尺寸n，这种特性意味着即使多达n个分组的突发数据也可以一次被发送出去，从而使得得在输出流中也存在突发情况，并且对于突发情况可以快速响应。这种算法允许突发流量，但是不得超过一个预定的最大长度。
1. 资源预留。